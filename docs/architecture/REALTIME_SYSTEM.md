# WebSocket Realtime System

## Overview
ระบบ WebSocket แบบ custom-built สำหรับการสื่อสารแบบ realtime ระหว่าง server และ clients โดยรองรับ:
- HMAC-based token authentication
- Channel-based subscriptions (system, clinic, user)
- Admin broadcast API
- Health monitoring endpoint

---

## Architecture

### 1. WebSocket Server (`lib/realtime/ws-server.ts`)
**Port:** `WS_PORT` (default: 3001)  
**Features:**
- HMAC token verification (generated by `/api/ws/auth`)
- User authentication via Supabase admin client
- Channel subscription management (SUBSCRIBE/UNSUBSCRIBE)
- Ping/pong keep-alive (30s interval)
- HTTP endpoints on same port:
  - `GET /health` → returns `{ ok, uptime, memory, clients, byRole, byClinic }`
  - `POST /broadcast` → send messages to filtered clients (requires `WS_ADMIN_SECRET`)

**Start server:**
\`\`\`bash
pnpm run ws:start
# or
tsx scripts/ws-server.ts
\`\`\`

---

### 2. Authentication Flow (`app/api/ws/auth/route.ts`)
**Endpoint:** `GET /api/ws/auth`  
**Returns:** `{ wsUrl, token, userId }`

**Token Structure:**
\`\`\`typescript
{
  userId: string;
  timestamp: number;
  signature: string; // HMAC-SHA256 of "userId:timestamp"
}
\`\`\`
Base64-encoded JSON passed as `?token=...` query parameter.

**TTL:** Configurable via `WS_TOKEN_TTL_MS` (default: 10 minutes)

**Dev Override:** Set `WS_TEST_USER_ID` in non-production to bypass session check for smoke tests.

---

### 3. Channels (`lib/realtime/channels.ts`)
\`\`\`typescript
channels.system.announcements     // system:announcements
channels.system.maintenance       // system:maintenance
channels.clinic.queue(clinicId)   // clinic:{clinicId}:queue
channels.clinic.alerts(clinicId)  // clinic:{clinicId}:alerts
channels.user.notifications(userId) // user:{userId}:notifications
\`\`\`

---

### 4. Client Hooks

#### Authenticated utilities (`components/realtime/WebSocketClient.tsx`)
Exports the session-aware `useWebSocket(options)` hook together with `WebSocketProvider`
and `useWebSocketContext`. These share reconnection/backoff logic and expose helpers for
`sendMessage`, `subscribe`, and `unsubscribe` while surfacing connection status for UI
indicators.

#### `useWebSocketConnection(options)`
High-level hook that fetches `/api/ws/auth`, builds the tokenized URL, and auto-connects.
Useful for feature-specific subscribers that do not need the provider context.

\`\`\`tsx
const { isReady, sendMessage, subscribe, unsubscribe } = useWebSocketConnection({
  callbacks: {
    onMessage: (msg) => {
      // handle message
    }
  }
});
\`\`\`

---

### 5. Components

#### `AnnouncementSubscriber` (Global)
Auto-subscribes to `system:announcements` on mount; shows toast for ANNOUNCEMENT messages.

**Location:** `components/realtime/AnnouncementSubscriber.tsx`  
**Mounted in:** `app/layout.tsx`

#### `ChannelSubscriber` (Page-specific)
Reusable component for subscribing to custom channels.

**Usage:**
\`\`\`tsx
<ChannelSubscriber
  channels={[channels.clinic.queue('clinic-123')]}
  onMessage={(msg) => {
    if (msg.type === 'QUEUE_UPDATE') {
      // refresh queue UI
    }
  }}
/>
\`\`\`

---

### 6. Admin Broadcast

#### UI: `app/admin/broadcast/page.tsx`
Admin-only page to send announcements.

**Fields:**
- Channel dropdown (system:announcements, system:maintenance)
- Message textarea
- Send button

#### API: `app/api/admin/broadcast/route.ts`
**Endpoint:** `POST /api/admin/broadcast`  
**Auth:** Requires `user.role === 'admin'`  
**Body:**
\`\`\`json
{
  "message": {
    "type": "ANNOUNCEMENT",
    "data": { "message": "Hello", "at": "2025-11-03T..." }
  },
  "filter": {
    "channels": ["system:announcements"]
  }
}
\`\`\`
Proxies to WS `/broadcast` endpoint with `WS_ADMIN_SECRET`.

---

### 7. Broadcast Filters
When calling `/broadcast`, you can filter recipients:
\`\`\`typescript
{
  userIds?: string[];     // specific user IDs
  clinicIds?: string[];   // specific clinic IDs
  roles?: string[];       // specific roles (admin, sales_staff, etc.)
  channels?: string[];    // clients subscribed to these channels
}
\`\`\`

---

## Environment Variables

\`\`\`env
# WebSocket Server
WS_PORT=3001
WS_TOKEN_SECRET=your-secret-key
WS_TOKEN_TTL_MS=600000  # 10 minutes
WS_ADMIN_SECRET=your-admin-secret

# Client
NEXT_PUBLIC_WS_URL=ws://localhost:3001

# Dev Testing
WS_TEST_USER_ID=user-abc-123  # optional, non-prod only
\`\`\`

---

## Testing Scripts

### Health Check
\`\`\`bash
pnpm run ws:health
# or
tsx scripts/check-ws-health.ts
\`\`\`

### Broadcast Demo
\`\`\`bash
pnpm run ws:broadcast:demo
# or
tsx scripts/ws-broadcast.ts --message "Test" --type ANNOUNCEMENT --channels system:announcements
\`\`\`

### End-to-End Smoke Test
\`\`\`bash
pnpm run ws:smoke
# or
tsx scripts/ws-e2e-smoke.ts
\`\`\`

**Requirements:** Set `WS_TEST_USER_ID` or have valid session; WS server must be running.

---

## Message Types

### Client → Server
- `PING` → server responds with `PONG`
- `SUBSCRIBE` → `{ type: 'SUBSCRIBE', data: { channels: [...] } }`
- `UNSUBSCRIBE` → `{ type: 'UNSUBSCRIBE', data: { channels: [...] } }`

### Server → Client
- `CONNECTED` → `{ type: 'CONNECTED', data: { clientId, userId } }`
- `PONG` → response to PING
- `ANNOUNCEMENT` → `{ type: 'ANNOUNCEMENT', data: { message, at } }`
- Custom message types (e.g., `QUEUE_UPDATE`, `CLINIC_ALERT`)

---

## Integration Checklist

- [x] WS server with auth + health + broadcast
- [x] Token generation endpoint (`/api/ws/auth`)
- [x] Client hooks (`useWebSocket`, `useWebSocketConnection`)
- [x] Global announcement subscriber
- [x] Reusable `ChannelSubscriber` component
- [x] Admin broadcast UI + API
- [x] Enhanced `/health` with uptime/memory/client stats
- [x] Consolidated WS launcher script (`ws-server.ts`)
- [ ] Page-specific subscriptions (admin dashboard, clinic queue) → **next step**
- [ ] Structured logging for WS events
- [ ] Metrics dashboard (optional)

---

## Next Steps

1. **Add page-specific subscribers:**
   - Admin dashboard → subscribe to `system:maintenance` for downtime alerts
   - Clinic queue page → subscribe to `clinic:{clinicId}:queue` for live queue updates

2. **Structured logging:**
   - Log auth events, broadcast sends, channel activity with timestamps/context

3. **Monitoring:**
   - Extend `/health` with connection history, error rates
   - Optional: export metrics to monitoring service

4. **Documentation:**
   - Add JSDoc to WS server methods
   - Create diagrams for auth/subscription flow

---

## Troubleshooting

**Connection fails:**
- Check WS server is running (`pnpm run ws:start`)
- Verify `NEXT_PUBLIC_WS_URL` matches server port
- Ensure token is valid (check `/api/ws/auth` response)

**Broadcast not received:**
- Confirm client is subscribed to target channel
- Check filter criteria (userIds, clinicIds, roles, channels)
- Verify `WS_ADMIN_SECRET` matches between API and server

**Token expired:**
- Increase `WS_TOKEN_TTL_MS` or implement token refresh logic
- Check system clock sync between client/server

---

**Last Updated:** November 3, 2025  
**Status:** ✅ Core realtime infrastructure complete; ready for page-specific integrations
